format_version: 1.1.0
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

trigger_map:
- tag: "*"
  workflow: primary
- push_branch: "*"
  workflow: primary
- pull_request_target_branch: "*"
  workflow: primary

workflows:
  primary:
    steps:
    - script:
        title: Setup
        inputs:
        - content: |-
            #!/bin/bash
            set -eu -o pipefail
            brew install cmake
            brew unlink node
            brew install awscli homebrew/versions/node4-lts
            brew link homebrew/versions/node4-lts
            gem install xcpretty --no-rdoc --no-ri
    - script:
        title: Check for publishing
        inputs:
        - content: |-
            #!/bin/bash
            PACKAGE_JSON_VERSION=$(node -e "console.log(require('./package.json').version)")
            if [[ ${BITRISE_GIT_TAG:-} == "node-v${PACKAGE_JSON_VERSION}" ]]; then
                envman add --key PUBLISH --value true
                envman add --key BUILDTYPE --value "Release"
            else
                envman add --key PUBLISH --value false
                envman add --key BUILDTYPE --value "Debug"
            fi
            echo $PACKAGE_JSON_VERSION;
            echo $PUBLISH;
            echo $BUILDTYPE;
    - script:
        title: Run build script
        inputs:
        - content: |-
            #!/bin/bash
            set -eu -o pipefail
            make node
    - script:
        title: Run test script
        run_if: '{{enveq "PUBLISH" "false"}}'
        inputs:
        - content: |-
            #!/bin/bash
            set -eu -o pipefail
            make test-node || envman add --key RESULT --value "$?"
    - script:
        title: Run after_script
        inputs:
        - content: |-
            #!/bin/bash
            set -eu -o pipefail
            ./platform/node/scripts/after_script.sh ${BITRISE_BUILD_NUMBER}
            exit ${RESULT:-0}
    - slack:
        title: Post to Slack
        run_if: '{{enveq "SKIPCI" "false"}}'
        inputs:
        - webhook_url: "$SLACK_HOOK_URL"
        - channel: "#gl-bots"
        - from_username: 'Bitrise Node macOS'
        - from_username_on_error: 'Bitrise Node macOS'
        - message: '<${BITRISE_BUILD_URL}|Build #${BITRISE_BUILD_NUMBER}>
            for <https://github.com/mapbox/mapbox-gl-native/compare/${BITRISE_GIT_BRANCH}|mapbox/mapbox-gl-native@${BITRISE_GIT_BRANCH}>
            by ${GIT_CLONE_COMMIT_COMMITER_NAME}
            passed'
        - message_on_error: '<${BITRISE_BUILD_URL}|Build #${BITRISE_BUILD_NUMBER}>
            for <https://github.com/mapbox/mapbox-gl-native/compare/${BITRISE_GIT_BRANCH}|mapbox/mapbox-gl-native@${BITRISE_GIT_BRANCH}>
            by ${GIT_CLONE_COMMIT_COMMITER_NAME}
            failed'
        - icon_url: https://bitrise-public-content-production.s3.amazonaws.com/slack/bitrise-slack-icon-128.png
        - icon_url_on_error: https://bitrise-public-content-production.s3.amazonaws.com/slack/bitrise-slack-error-icon-128.png
